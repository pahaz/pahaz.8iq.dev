<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ –î–æ–º–æ—Ñ–æ–Ω–Ω—ã—Ö –ó–≤–æ–Ω–∫–æ–≤</title>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Chart.js -->
    <script src="./chart.min.js"></script>
    <link rel="stylesheet" href="./logs-ui.css">
</head>
<body>

<header>
    <h1>Intercom Analytics</h1>
    <button id="btnExport" title="–≠–∫—Å–ø–æ—Ä—Ç –≤ JSON">üíæ</button>
    <nav class="nav-tabs">
        <button class="nav-btn active">1. –ó–∞–≥—Ä—É–∑–∫–∞</button>
        <button class="nav-btn">2. –°–≤–æ–¥–∫–∞</button>
        <button class="nav-btn">3. –î–µ—Ç–∞–ª–∏</button>
    </nav>
</header>

<main>
    <!-- SHARED FILTERS -->
    <div id="shared-filters" class="filters-bar" style="display: none;">
        <div class="filter-group">
            <label>–ü–µ—Ä–∏–æ–¥ —Å:</label>
            <input type="date" id="filterDateStart">
        </div>
        <div class="filter-group">
            <label>–ü–µ—Ä–∏–æ–¥ –ø–æ:</label>
            <input type="date" id="filterDateEnd">
        </div>
        <div class="filter-group">
            <label>–°—Ç–∞—Ç—É—Å:</label>
            <select id="filterStatus">
                <option value="all">–í—Å–µ</option>
                <option value="answered">–ü—Ä–∏–Ω—è—Ç</option>
                <option value="opened">–û—Ç–∫—Ä—ã—Ç–æ</option>
                <option value="missed">–ü—Ä–æ–ø—É—â–µ–Ω</option>
                <option value="fail">–û—à–∏–±–∫–∞</option>
            </select>
        </div>
        <div class="filter-group" style="display: none;">
            <label>–•—É–∫:</label>
            <select id="filterPush">
                <option value="all">–í—Å–µ</option>
                <option value="has_push">–° —Ö—É–∫–æ–º</option>
                <option value="no_push">–ë–µ–∑ —Ö—É–∫–∞</option>
                <option value="success_push">–£—Å–ø–µ—à–Ω—ã–π —Ö—É–∫</option>
                <option value="unsuccess_push">–ù–ï–£—Å–ø–µ—à–Ω—ã–π —Ö—É–∫</option>
            </select>
        </div>
        <div class="filter-group">
            <label>–ö–≤–∞—Ä—Ç–∏—Ä–∞:</label>
            <input type="text" id="filterApt" list="list-apt" placeholder="–ù–æ–º–µ—Ä...">
            <datalist id="list-apt"></datalist>
        </div>
        <div class="filter-group">
            <label>–ü–∞–Ω–µ–ª—å:</label>
            <input type="text" id="filterPanel" list="list-panel" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ...">
            <datalist id="list-panel"></datalist>
        </div>
        <div class="filter-group">
            <label>Call ID:</label>
            <input type="text" id="filterId" list="list-id" placeholder="ID...">
            <datalist id="list-id"></datalist>
        </div>
        <button class="btn-primary" id="btnApplyFilters" style="width: auto; margin-top: auto;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </div>

    <!-- MODE 1: UPLOAD -->
    <section id="view-upload" class="view-section active">
        <div class="upload-container">
            <h2>–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤</h2>
            <p style="color: var(--text-sub); margin-bottom: 1rem;">–ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV –∏–ª–∏ JSON —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–≤–æ–Ω–∫–æ–≤</p>

            <div class="drop-zone" id="dropZone">
                –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏—Ç–µ
            </div>

            <button class="btn-primary" id="btnUpload">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–≥–∏</button>

            <div class="progress-wrapper" id="progressWrapper">
                <div class="status-text" id="statusText">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill" id="progressBar"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- MODE 2: DASHBOARD -->
    <section id="view-dashboard" class="view-section">
        <!-- Funnel -->
        <div class="funnel-container">
            <div class="funnel-step">
                <div class="fs-label">–í—Å–µ–≥–æ –∑–≤–æ–Ω–∫–æ–≤</div>
                <div class="fs-value"><span id="val-total">0</span> <span class="fs-unfiltered" id="val-total-all">(0)</span></div>
                <div class="fs-percent"><span id="perc-total">0%</span> <span class="fs-unfiltered" id="perc-total-all">(0%)</span></div>
            </div>
            <div class="funnel-step status-answered-border">
                <div class="fs-label">–û—Ç–≤–µ—á–µ–Ω–æ</div>
                <div class="fs-value"><span id="val-answered">0</span> <span class="fs-unfiltered" id="val-answered-all">(0)</span></div>
                <div class="fs-percent"><span id="perc-answered">0%</span> <span class="fs-unfiltered" id="perc-answered-all">(0%)</span></div>
            </div>
            <div class="funnel-step status-opened-border">
                <div class="fs-label">–î–≤–µ—Ä–µ–π –æ—Ç–∫—Ä—ã—Ç–æ</div>
                <div class="fs-value"><span id="val-opened">0</span> <span class="fs-unfiltered" id="val-opened-all">(0)</span></div>
                <div class="fs-percent"><span id="perc-opened">0%</span> <span class="fs-unfiltered" id="perc-opened-all">(0%)</span></div>
            </div>
            <div class="funnel-step status-missed-border">
                <div class="fs-label">–ü—Ä–æ–ø—É—â–µ–Ω–æ</div>
                <div class="fs-value"><span id="val-missed">0</span> <span class="fs-unfiltered" id="val-missed-all">(0)</span></div>
                <div class="fs-percent"><span id="perc-missed">0%</span> <span class="fs-unfiltered" id="perc-missed-all">(0%)</span></div>
            </div>
            <div class="funnel-step status-fail-border">
                <div class="fs-label">–û—à–∏–±–∫–∏ (Fail)</div>
                <div class="fs-value"><span id="val-fail">0</span> <span class="fs-unfiltered" id="val-fail-all">(0)</span></div>
                <div class="fs-percent"><span id="perc-fail">0%</span> <span class="fs-unfiltered" id="perc-fail-all">(0%)</span></div>
            </div>
        </div>
        <div class="funnel-container">
            <div class="funnel-step">
                <div class="fs-label">–í–µ–±—Ö—É–∫–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                <div class="fs-value"><span id="val-push-sent">0</span> <span class="fs-unfiltered" id="val-push-sent-all">(0)</span></div>
                <div class="fs-percent"><span id="perc-push-sent">0%</span> <span class="fs-unfiltered" id="perc-push-sent-all">(0%)</span></div>
            </div>
            <div class="funnel-step status-opened-border">
                <div class="fs-label">–í–µ–±—Ö—É–∫–æ–≤ —É—Å–ø–µ—à–Ω–æ</div>
                <div class="fs-value"><span id="val-push-success">0</span> <span class="fs-unfiltered" id="val-push-success-all">(0)</span></div>
                <div class="fs-percent"><span id="perc-push-success">0%</span> <span class="fs-unfiltered" id="perc-push-success-all">(0%)</span></div>
            </div>
            <div class="funnel-step status-fail-border">
                <div class="fs-label">–í–µ–±—Ö—É–∫–æ–≤ –Ω–µ—É—Å–ø–µ—à–Ω–æ</div>
                <div class="fs-value"><span id="val-push-fail">0</span> <span class="fs-unfiltered" id="val-push-fail-all">(0)</span></div>
                <div class="fs-percent"><span id="perc-push-fail">0%</span> <span class="fs-unfiltered" id="perc-push-fail-all">(0%)</span></div>
            </div>
        </div>

        <div class="funnel-container">
            <div class="funnel-step">
                <div class="fs-label">–ü—É—à–µ–π –î–æ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                <div class="fs-value"><span id="val-push-doma-sent">0</span> <span class="fs-unfiltered" id="val-push-doma-sent-all">(0)</span></div>
                <div class="fs-percent"><span id="perc-push-doma-sent">0%</span> <span class="fs-unfiltered" id="perc-push-doma-sent-all">(0%)</span></div>
            </div>
            <div class="funnel-step status-opened-border">
                <div class="fs-label">–ü—É—à–µ–π –î–æ–º–∞ —É—Å–ø–µ—à–Ω–æ</div>
                <div class="fs-value"><span id="val-push-doma-success">0</span> <span class="fs-unfiltered" id="val-push-doma-success-all">(0)</span></div>
                <div class="fs-percent"><span id="perc-push-doma-success">0%</span> <span class="fs-unfiltered" id="perc-push-doma-success-all">(0%)</span></div>
            </div>
            <div class="funnel-step status-fail-border">
                <div class="fs-label">–ü—É—à–µ–π –î–æ–º–∞ –Ω–µ—É—Å–ø–µ—à–Ω–æ</div>
                <div class="fs-value"><span id="val-push-doma-fail">0</span> <span class="fs-unfiltered" id="val-push-doma-fail-all">(0)</span></div>
                <div class="fs-percent"><span id="perc-push-doma-fail">0%</span> <span class="fs-unfiltered" id="perc-push-doma-fail-all">(0%)</span></div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <div class="chart-card full-width">
                <div class="card-header">
                    <div class="card-title">–î–∏–Ω–∞–º–∏–∫–∞ –∑–≤–æ–Ω–∫–æ–≤</div>
                    <div class="card-controls">
                        <select id="historyBreakdown" class="select-sm">
                            <option value="none">–ë–µ–∑ —Ä–∞–∑–±–∏–≤–∫–∏</option>
                            <option value="panel">–ü–æ –ø–∞–Ω–µ–ª—è–º</option>
                            <option value="apt">–ü–æ –∫–≤–∞—Ä—Ç–∏—Ä–∞–º</option>
                        </select>
                        <select id="historyGroup" class="select-sm">
                            <option value="day">–ü–æ –¥–Ω—è–º</option>
                            <option value="hour">–ü–æ —á–∞—Å–∞–º</option>
                            <option value="15min">–ü–æ 15 –º–∏–Ω—É—Ç</option>
                            <option value="1min">–ü–æ 1 –º–∏–Ω—É—Ç–µ</option>
                        </select>
                    </div>
                </div>
                <div style="height: 400px;">
                    <canvas id="chartHistory"></canvas>
                </div>
            </div>

            <div class="chart-card full-width">
                <div class="card-header">
                    <div class="card-title">–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–≤ –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</div>
                    <div class="card-controls">
                        <select id="durationBreakdown" class="select-sm">
                            <option value="none">–ë–µ–∑ —Ä–∞–∑–±–∏–≤–∫–∏</option>
                            <option value="panel">–ü–æ –ø–∞–Ω–µ–ª—è–º</option>
                            <option value="apt">–ü–æ –∫–≤–∞—Ä—Ç–∏—Ä–∞–º</option>
                        </select>
                    </div>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="chartDuration"></canvas>
                </div>
            </div>

            <div class="chart-card full-width">
                <div class="card-header">
                    <div class="card-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –ø–∞–Ω–µ–ª—è–º: –°—Ç–∞—Ç—É—Å—ã vs –ö–≤–∞—Ä—Ç–∏—Ä—ã (Log Scale)</div>
                </div>
                <div id="panelAnalysisWrapper" style="min-height: 400px; position: relative;">
                    <canvas id="chartPanelAnalysis"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- MODE 3: DETAILS -->
    <section id="view-details" class="view-section">
        <div class="details-layout">
            <!-- Left: List -->
            <div class="calls-list-panel">
                <div class="calls-table-container" id="callsTableBody">
                    <!-- Rows injected via JS -->
                    <div class="empty-state">–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</div>
                </div>
                <div id="callsTableMore"></div>
            </div>

            <!-- Right: Detail -->
            <div class="call-detail-panel" id="detailPanel">
                <div class="empty-state" id="detailPlaceholder">–í—ã–±–µ—Ä–∏—Ç–µ –∑–≤–æ–Ω–æ–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞</div>

                <div id="detailContent" style="display: none;">
                    <div class="cd-header">
                        <div class="cd-title">–ó–≤–æ–Ω–æ–∫ <span id="d-id" style="font-size: 0.9rem; font-family: monospace;">#ID</span>&nbsp;<span id="d-status-badge" class="cr-status">STATUS</span></div>


                        <div class="meta-grid" id="d-meta-grid">
                            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ JS -->
                        </div>
                    </div>

                    <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 1rem; margin-bottom: 0.5rem;">
                        <h3 style="margin: 0;">–¢–∞–π–º–ª–∞–π–Ω —Å–æ–±—ã—Ç–∏–π</h3>
                        <div id="timeline-filters" style="display: flex; gap: 5px; flex-wrap: wrap;"></div>
                    </div>
                    <div class="timeline-horizontal" id="d-timeline">
                        <!-- Events injected via JS -->
                    </div>

                    <h3 style="margin-top: 2rem; margin-bottom: 1rem;">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ª–æ–≥–∏</h3>

                    <details id="details-panel-logs">
                        <summary>–î–∞–Ω–Ω—ã–µ –ø–∞–Ω–µ–ª–∏ (Call Panel)</summary>
                        <div class="content">
                            <pre class="log-block" id="d-log-panel">{}</pre>
                        </div>
                    </details>

                    <details id="details-client-logs">
                        <summary>–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ (Call Client)</summary>
                        <div class="content">
                            <pre class="log-block" id="d-log-client">{}</pre>
                        </div>
                    </details>

                    <div id="d-extra-calls">
                        <!-- –†–∞—Å–∫—Ä—ã–≤–∞—é—â–∏–π—Å—è —Å–ø–∏—Å–æ–∫ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–æ–≥ -->
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- MODAL -->
    <div id="dataModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>–î–µ—Ç–∞–ª–∏ –¥–∞–Ω–Ω—ã—Ö</h3>
                <span class="close-modal" id="closeModalBtn">&times;</span>
            </div>
            <div class="modal-body">
                <pre id="modalDataContent"></pre>
            </div>
        </div>
    </div>
</main>
<script src="./logs-ui.js"></script>
<script src="./logs-autoload.js"></script>
<script src="./logs-parser.js"></script>
<script src="./push-logs-parser.js"></script>
<script src="./push-worker-parser.js"></script>
</body>
</html>
